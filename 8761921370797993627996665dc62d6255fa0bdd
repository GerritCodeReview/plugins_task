{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "6268cfeb_55d8f94e",
        "filename": "tools/playbooks/install_docker.yaml",
        "patchSetId": 6
      },
      "lineNbr": 11,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-05-10T20:54:57Z",
      "side": 1,
      "message": "This is supposed to be enough to get the user\u0027s groups updated so that it can run docker commands without sudo, but it doesn\u0027t seem to be working:\n\n PermissionError: [Errno 13] Permission denied\n\nhttps://ci.gerritcodereview.com/t/gerrit/build/7c53b8eaad544d90b7c0021a49799fb5",
      "range": {
        "startLine": 11,
        "startChar": 8,
        "endLine": 11,
        "endChar": 21
      },
      "revId": "8761921370797993627996665dc62d6255fa0bdd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5f90bddc_4bccb92d",
        "filename": "tools/playbooks/install_docker.yaml",
        "patchSetId": 6
      },
      "lineNbr": 11,
      "author": {
        "id": 1087826
      },
      "writtenOn": "2021-05-10T22:21:32Z",
      "side": 1,
      "message": "At the end of this shell process, we\u0027ll drop back to the previous group membership and the next process won\u0027t pick it up because the SSH connection is cached.  That can be fixed by having Ansible reset the ssh connection, but this looks like it has a lot in common with the \"ensure-docker\" role that\u0027s in the zuul-jobs library.  So we might be able to make this simpler by using that role for some or all of this.\n\nIf you want, you can replace the tasks section with just a role section like this:\n\n  roles:\n    - ensure-docker\n\nOr, actually since it looks like you also want compose:\n\n  roles:\n    - name: ensure-docker\n      docker_compose_install: true\n\nAnd if you need to do anything else, you can keep the tasks section with the shell task (it will run after the role).\n\nHere\u0027s the doc for the role: https://zuul-ci.org/docs/zuul-jobs/container-roles.html#role-ensure-docker\n\nAnd here\u0027s the source if there are any questions about what it\u0027s doing; https://opendev.org/zuul/zuul-jobs/src/branch/master/roles/ensure-docker\n\nFor completeness, here\u0027s where that role resets the ssh connection: https://opendev.org/zuul/zuul-jobs/src/branch/master/roles/ensure-docker/tasks/docker-setup.yaml#L62",
      "parentUuid": "6268cfeb_55d8f94e",
      "range": {
        "startLine": 11,
        "startChar": 8,
        "endLine": 11,
        "endChar": 21
      },
      "revId": "8761921370797993627996665dc62d6255fa0bdd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "617dfc39_2085561c",
        "filename": "tools/playbooks/install_docker.yaml",
        "patchSetId": 6
      },
      "lineNbr": 11,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-05-10T22:29:22Z",
      "side": 1,
      "message": "\u003e Or, actually since it looks like you also want compose:\n\u003e \n\u003e   roles:\n\u003e     - name: ensure-docker\n\u003e       docker_compose_install: true\n\u003e \n\nWell that\u0027s a lot simpler, thanks ðŸ˜Š\n\nI didn\u0027t see anywhere in the docs where it provides an overview of what roles are. Does that exist?",
      "parentUuid": "5f90bddc_4bccb92d",
      "range": {
        "startLine": 11,
        "startChar": 8,
        "endLine": 11,
        "endChar": 21
      },
      "revId": "8761921370797993627996665dc62d6255fa0bdd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e05ec618_1ef2023e",
        "filename": "tools/playbooks/install_docker.yaml",
        "patchSetId": 6
      },
      "lineNbr": 11,
      "author": {
        "id": 1002666
      },
      "writtenOn": "2021-05-10T22:57:30Z",
      "side": 1,
      "message": "\u003e \u003e Or, actually since it looks like you also want compose:\n\u003e \u003e \n\u003e \u003e   roles:\n\u003e \u003e     - name: ensure-docker\n\u003e \u003e       docker_compose_install: true\n\u003e \u003e \n\u003e \n\u003e Well that\u0027s a lot simpler, thanks ðŸ˜Š\n\nUgh, except the version of compose it installed is too old. ðŸ˜­\n\n Version in\n \"/home/zuul/src/gerrit.googlesource.com/gerrit/plugins/task/test/docker/docker-compose.yaml\"\n is unsupported. You might be seeing this error because you\u0027re using the wrong\n Compose file version. Either specify a version of \"2\" (or \"2.0\") and place your\n service definitions under the `services` key, or omit the `version` key and place\n your service definitions at the root of the file to use version 1.\n\nWe\u0027re using version: \u00273\u0027, which has been supported since compose version 1.10.0: https://github.com/docker/compose/releases/tag/1.10.0\n\nDo I go back to installing compose myself in a task?",
      "parentUuid": "617dfc39_2085561c",
      "range": {
        "startLine": 11,
        "startChar": 8,
        "endLine": 11,
        "endChar": 21
      },
      "revId": "8761921370797993627996665dc62d6255fa0bdd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fd95b393_265fbb2d",
        "filename": "tools/playbooks/install_docker.yaml",
        "patchSetId": 6
      },
      "lineNbr": 11,
      "author": {
        "id": 1087826
      },
      "writtenOn": "2021-05-10T23:52:53Z",
      "side": 1,
      "message": "(I probably should have thought of the ensure-docker role first, sorry!)\n\nIt looks like the role installs docker-compose from the distro, and we\u0027re on an old debian right now.  So that might be the best approach (short of updating ensure-docker to install from elsewhere).  We can always remove the local task after we upgrade our base images.\n\nSo it looks like the job passes now and you\u0027re set; you cane remove the other job from zuul/config.  But note that right now, this job only exists on this branch; you\u0027ll need to copy it to other branches in this repo if you want it to run there.",
      "parentUuid": "e05ec618_1ef2023e",
      "range": {
        "startLine": 11,
        "startChar": 8,
        "endLine": 11,
        "endChar": 21
      },
      "revId": "8761921370797993627996665dc62d6255fa0bdd",
      "serverId": "173816e5-2b9a-37c3-8a2e-48639d4f1153"
    }
  ]
}